# Story 2.3: "Crisis Response" Feature Implementation

## Status
Backend Complete - Ready for Frontend Integration

## Story
**As a** user,
**I want** a dedicated "Crisis Simulator" feature that can generate a complete communications package,
**so that** I can respond to a food safety event instantly.

## Acceptance Criteria
1. **AC1**: A `/crisis` POST endpoint is implemented for crisis response generation
2. **AC2**: Crisis simulator UI allows inputting crisis scenario details (contamination, recall, etc.)
3. **AC3**: System generates revised labels with appropriate warnings and updates
4. **AC4**: Crisis response package includes public communications materials
5. **AC5**: Generated materials cover all affected markets automatically
6. **AC6**: Crisis response is logged to CrisisLogsTable for audit purposes
7. **AC7**: Crisis mode generates responses within 10 seconds for urgency
8. **AC8**: Crisis materials include media statements, updated labels, and regulatory notices

## Tasks / Subtasks

- [x] **Task 1: Implement Crisis Response Data Models** (AC: 6, 8)
  - [x] Define `CrisisScenario` interface with crisis types and severity
  - [x] Create `CrisisResponse` interface for complete response package
  - [x] Define `CrisisLog` interface for audit trail
  - [x] Add crisis-specific Zod schemas for validation
  - [x] Create `CommunicationMaterial` interfaces for different document types
  - [x] Export crisis types from `packages/shared`

- [x] **Task 2: Build Crisis Response Backend Logic** (AC: 1, 3, 7)
  - [x] Create `/crisis` endpoint handler in Lambda
  - [x] Implement crisis-specific AI prompt templates
  - [x] Add crisis severity assessment logic
  - [x] Generate revised product labels with warnings
  - [x] Implement expedited AI processing for crisis scenarios
  - [x] Add crisis-specific error handling and fallbacks

- [x] **Task 3: Implement Multi-Material Generation** (AC: 4, 8)
  - [x] Generate media press release templates
  - [x] Create regulatory notification documents
  - [x] Generate customer communication materials
  - [x] Produce internal crisis communication guidelines
  - [x] Add social media response templates
  - [x] Create email notification templates for stakeholders

- [x] **Task 4: Multi-Market Crisis Response** (AC: 5)
  - [x] Automatically generate crisis response for all affected markets
  - [x] Implement market-specific crisis communication requirements
  - [x] Add cultural sensitivity considerations per market
  - [x] Generate translated crisis materials for Portuguese markets
  - [x] Include market-specific regulatory authority contacts
  - [x] Add regional media contact recommendations

- [x] **Task 5: Crisis Logging and Audit Trail** (AC: 6)
  - [x] Implement CrisisLogsTable in DynamoDB
  - [x] Create crisis response audit logging
  - [x] Add timestamped crisis decision tracking
  - [x] Implement crisis response retrieval for historical analysis
  - [x] Add crisis impact assessment metrics
  - [x] Create crisis response reporting functionality

- [ ] **Task 6: Crisis Simulator UI Implementation** (AC: 2)
  - [ ] Create crisis scenario input form
  - [ ] Add crisis type selector (contamination, allergen, packaging, etc.)
  - [ ] Implement severity level selection
  - [ ] Add affected product and market selection
  - [ ] Create crisis timeline input fields
  - [ ] Add crisis description and context inputs

- [ ] **Task 7: Crisis Response Display and Actions** (AC: 3, 4, 8)
  - [ ] Create crisis response dashboard layout
  - [ ] Display generated materials in organized tabs
  - [ ] Implement revised label preview with warning highlights
  - [ ] Add communication materials download/export
  - [ ] Create crisis action checklist with recommended steps
  - [ ] Add crisis escalation contact information

- [ ] **Task 8: Crisis Mode Performance and UX** (AC: 7)
  - [ ] Optimize crisis response for 10-second generation
  - [ ] Add crisis urgency indicators in UI
  - [ ] Implement crisis notification system
  - [ ] Create crisis mode visual theme (red/urgent styling)
  - [ ] Add crisis timer and urgency metrics
  - [ ] Implement crisis response sharing and collaboration

## Dev Notes

### Previous Story Dependencies
**Story 2.1 (Global Markets Backend)** provides multi-market label generation capabilities.
**Story 2.2 (Polished UI)** establishes advanced UI patterns and state management.
This story adds the innovative Crisis Response feature as a key differentiator.

### Crisis Response Business Context
[Source: docs/prd/product-requirements-document-smartlabel-ai.md]

**Strategic Importance:**
- **FR5**: "Crisis Response" function as key technical and business differentiator
- **Innovation Factor**: Unique feature to impress sponsors and judges
- **Real-World Value**: Addresses critical need for rapid crisis communication

**Crisis Scenarios to Support:**
- **Contamination Events**: Bacterial, chemical, foreign object contamination
- **Allergen Issues**: Undeclared allergens, cross-contamination
- **Packaging Problems**: Incorrect labels, missing warnings
- **Regulatory Changes**: New restrictions, banned ingredients
- **Supply Chain Issues**: Supplier quality problems, ingredient source issues

### Crisis Response Data Models
**Enhanced Data Structures:**
```typescript
export type CrisisType =
  | 'contamination'
  | 'allergen'
  | 'packaging'
  | 'regulatory'
  | 'supply-chain';

export type CrisisSeverity = 'low' | 'medium' | 'high' | 'critical';

export interface CrisisScenario {
  crisisType: CrisisType;
  severity: CrisisSeverity;
  affectedProducts: string[];
  affectedMarkets: Market[];
  description: string;
  timeline: string;
  immediateActions?: string[];
}

export interface CrisisResponse {
  crisisId: string;
  scenario: CrisisScenario;
  revisedLabels: Record<Market, Label>;
  communicationMaterials: CommunicationMaterial[];
  actionPlan: ActionItem[];
  generatedAt: string;
  estimatedImpact: string;
}

export interface CommunicationMaterial {
  type: 'press-release' | 'regulatory-notice' | 'customer-email' | 'social-media' | 'internal-memo';
  market: Market;
  language: Language;
  content: string;
  urgency: CrisisSeverity;
  reviewRequired: boolean;
}
```

### Crisis-Specific AI Prompting
**Crisis Prompt Strategy:**
- **Urgency Context**: Emphasize speed and accuracy
- **Regulatory Focus**: Prioritize compliance and legal safety
- **Communication Tone**: Professional, reassuring, transparent
- **Market Adaptation**: Cultural sensitivity for crisis communication

**Prompt Templates by Crisis Type:**
- **Contamination**: Health focus, immediate action, product recall language
- **Allergen**: Safety warnings, ingredient transparency, affected populations
- **Packaging**: Correction notices, visual identification, replacement instructions
- **Regulatory**: Compliance updates, authority notifications, timeline communications

### Database Schema for Crisis Logging
[Source: architecture.md#database-schema - CrisisLogsTable]

**Enhanced CrisisLogsTable:**
```yaml
CrisisLogsTable:
  Type: AWS::DynamoDB::Table
  Properties:
    TableName: SmartLabel-CrisisLogs
    BillingMode: PAY_PER_REQUEST
    AttributeDefinitions:
      - { AttributeName: crisisId, AttributeType: S }
      - { AttributeName: productId, AttributeType: S }
      - { AttributeName: crisisType, AttributeType: S }
      - { AttributeName: timestamp, AttributeType: S }
    KeySchema:
      - { AttributeName: crisisId, KeyType: HASH }
    GlobalSecondaryIndexes:
      - IndexName: by-product
        KeySchema:
          - { AttributeName: productId, KeyType: HASH }
          - { AttributeName: timestamp, KeyType: RANGE }
      - IndexName: by-crisis-type
        KeySchema:
          - { AttributeName: crisisType, KeyType: HASH }
          - { AttributeName: timestamp, KeyType: RANGE }
```

### File Locations
[Source: architecture/source-tree.md]
- **Crisis Handler**: `apps/api/src/handlers/crisis.ts`
- **Crisis Templates**: `apps/api/src/templates/crisis/`
- **Crisis Types**: `packages/shared/types/crisis.ts`
- **Crisis Components**: `apps/web/src/components/crisis/`
- **Crisis Store**: `apps/web/src/stores/crisis-store.ts`

### Performance Requirements for Crisis Mode
[Source: NFR2 adapted for crisis urgency]
- **Response Time**: 10 seconds maximum (vs 15 for normal generation)
- **Priority Processing**: Crisis requests get priority in AI queue
- **Simplified Validation**: Streamlined validation for speed
- **Cached Templates**: Pre-loaded crisis communication templates

### Crisis UI/UX Design
**Crisis Mode Visual Design:**
- **Urgent Theme**: Red accent colors, bold typography
- **Clear Hierarchy**: Critical information prioritized
- **Action-Oriented**: Prominent action buttons and next steps
- **Progress Indicators**: Real-time generation progress for urgency

**Crisis Dashboard Sections:**
1. **Crisis Input**: Scenario selection and details
2. **Generated Response**: Revised labels and communications
3. **Action Plan**: Recommended next steps and timeline
4. **Sharing**: Export and distribution options

### Regulatory and Legal Considerations
**Compliance Requirements:**
- **Audit Trail**: Complete logging for regulatory review
- **Legal Review**: Flag materials requiring legal approval
- **Authority Notifications**: Market-specific regulatory contacts
- **Documentation**: Crisis response decision documentation

### Multi-Market Crisis Adaptation
**Market-Specific Crisis Handling:**
- **EU/Spain**: EFSA notifications, EU crisis protocols
- **Angola**: Portuguese authorities, developing market considerations
- **Macau**: Dual authority reporting (China/Portugal heritage)
- **Brazil**: ANVISA protocols, large market impact considerations

## Testing

### Testing Standards
[Source: architecture/tech-stack.md]
- **Crisis Simulation Tests**: Realistic crisis scenarios
- **Performance Tests**: 10-second response requirement
- **Multi-Market Tests**: Crisis response across all markets
- **Audit Tests**: Crisis logging and retrieval accuracy

### Test Requirements for This Story
- **Crisis Logic Tests**:
  - Crisis type classification and severity assessment
  - Crisis-specific prompt generation
  - Multi-material generation accuracy
  - Crisis logging and audit trail
- **Performance Tests**:
  - 10-second response time validation
  - Crisis priority processing
  - Large-scale crisis scenario handling
- **Integration Tests**:
  - Complete crisis workflow from input to response
  - Multi-market crisis response generation
  - Crisis materials export and sharing

### Test File Locations
- **Crisis Handler Tests**: `apps/api/src/__tests__/handlers/crisis.test.ts`
- **Crisis Component Tests**: `apps/web/src/components/__tests__/crisis/`
- **Crisis Integration Tests**: `apps/api/tests/integration/crisis.test.ts`
- **Crisis E2E Tests**: `apps/web/tests/e2e/crisis-workflow.spec.ts`

### Crisis Test Scenarios
**Realistic Crisis Simulations:**
- **Salmonella Contamination**: Multi-market recall scenario
- **Undeclared Nuts**: Allergen crisis with translated materials
- **Packaging Mix-up**: Label correction with urgent timeline
- **Regulatory Ban**: Ingredient prohibition with reformulation guidance

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| Sep 17, 2025 | 1.0 | Initial story draft for Crisis Response Feature | Bob, SM |

## Dev Agent Record
*This section records the development agent's implementation work*

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Crisis handler tests passed successfully
- All backend compilation completed without errors
- Crisis response generation tested under 10-second requirement
- Multi-market crisis scenarios validated

### Completion Notes List
- **Backend Crisis Response Core Complete**: Full crisis handler implemented with 10-second response time target
- **Data Models Implemented**: Complete TypeScript interfaces and Zod schemas for all crisis types
- **Multi-Material Generation**: Automated generation of press releases, regulatory notices, customer emails, social media responses, and internal memos
- **Multi-Market Support**: Automatic crisis response for all affected markets with cultural and regulatory considerations
- **Crisis Audit Trail**: Complete DynamoDB logging system with crisis statistics and historical analysis
- **AI Integration**: Crisis-specific prompts with fallback templates for reliability
- **Error Handling**: Comprehensive error handling with graceful degradation
- **Testing**: Unit tests covering crisis scenarios, multi-market responses, and performance requirements

### File List
#### Backend Files
- `packages/shared/src/types.ts` - Crisis response data models (CrisisScenario, CrisisResponse, CrisisLog, etc.)
- `packages/shared/src/schemas.ts` - Zod validation schemas for crisis types
- `apps/api/src/handlers/crisis.ts` - Main crisis response Lambda handler
- `apps/api/src/utils/bedrock.ts` - Extended with crisis-specific AI prompting
- `apps/api/src/utils/dynamodb.ts` - Crisis logging and audit trail functions
- `apps/api/src/__tests__/handlers/crisis.test.ts` - Crisis handler tests
- `packages/shared/__tests__/schemas/crisis.test.ts` - Crisis schema validation tests

#### Key Implementation Details
- Crisis response generates within 10-second target for all severity levels
- Supports 5 crisis types: contamination, allergen, packaging, regulatory, supply-chain
- Generates responses for all 5 markets: EU, ES, AO, MO, BR
- Produces 5 communication material types per market
- Complete audit trail with DynamoDB integration
- Fallback templates when AI service unavailable

## QA Results
*Results from QA Agent review will be added here after story completion*