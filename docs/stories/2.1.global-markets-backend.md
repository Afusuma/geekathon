# Story 2.1: Backend Expansion for Global Markets

## Status
Draft

## Story
**As a** developer,
**I want** to expand the AI generation engine to support three new markets (Angola, Macau, and Brazil),
**so that** our application demonstrates its global capabilities.

## Acceptance Criteria
1. **AC1**: The `/generate` endpoint accepts a `market` parameter for Angola, Macau, Brazil, and EU/Spain
2. **AC2**: Market-specific prompts are implemented for each of the four supported markets
3. **AC3**: Each market generates labels with region-appropriate compliance requirements
4. **AC4**: Portuguese translation is implemented for Brazilian and Angolan markets
5. **AC5**: Market-specific certifications and symbols are included where applicable
6. **AC6**: Updated data models support multi-market label variations
7. **AC7**: Database schema accommodates market-specific metadata
8. **AC8**: All markets maintain the same 15-second performance requirement

## Tasks / Subtasks

- [ ] **Task 1: Extend Data Models for Multi-Market Support** (AC: 1, 6, 7)
  - [ ] Add `Market` enum type: `'EU' | 'ES' | 'AO' | 'MO' | 'BR'` (Angola, Macau, Brazil)
  - [ ] Extend `Label` interface with market-specific fields
  - [ ] Add `marketSpecificData` object for region customizations
  - [ ] Update Zod schemas for market validation
  - [ ] Add language support fields (`language: 'en' | 'pt'`)
  - [ ] Export updated types from `packages/shared`

- [ ] **Task 2: Implement Market-Specific Prompt Templates** (AC: 2, 3, 5)
  - [ ] Create prompt template system for market customization
  - [ ] Research and implement Angola (Portuguese colony) food regulations
  - [ ] Research and implement Macau (SAR China) food labeling requirements
  - [ ] Research and implement Brazil (Portuguese) food safety standards
  - [ ] Add market-specific certification requirements (IFS, local standards)
  - [ ] Create prompt validation for market consistency

- [ ] **Task 3: Portuguese Translation Integration** (AC: 4)
  - [ ] Implement translation service for Portuguese markets
  - [ ] Add language detection and routing logic
  - [ ] Create Portuguese prompt templates for Brazil and Angola
  - [ ] Implement bilingual label generation (English + Portuguese)
  - [ ] Add translation validation and quality checks
  - [ ] Handle Brazilian Portuguese vs European Portuguese differences

- [ ] **Task 4: Enhanced Generate Handler** (AC: 1, 8)
  - [ ] Update `/generate` endpoint to accept market parameter
  - [ ] Implement market-specific routing logic
  - [ ] Add market validation and error handling
  - [ ] Maintain performance requirements across all markets
  - [ ] Implement market-specific response formatting
  - [ ] Add market metadata to generated labels

- [ ] **Task 5: Database Schema Updates** (AC: 7)
  - [ ] Add market index to DynamoDB for efficient queries
  - [ ] Update `Label` table schema with market fields
  - [ ] Create market-specific GSI for analytics
  - [ ] Implement market-based label retrieval
  - [ ] Add data migration for existing EU labels
  - [ ] Update SAM template with new indexes

- [ ] **Task 6: Market-Specific Business Logic** (AC: 3, 5)
  - [ ] Implement Angola compliance rules (Portuguese colony regulations)
  - [ ] Implement Macau compliance rules (Chinese SAR + Portuguese influence)
  - [ ] Implement Brazil compliance rules (ANVISA food regulations)
  - [ ] Add region-specific allergen handling
  - [ ] Implement local certification logic (IFS, organic, etc.)
  - [ ] Create market validation functions

- [ ] **Task 7: API Enhancement and Error Handling** (AC: 1, 8)
  - [ ] Add comprehensive market parameter validation
  - [ ] Implement market-specific error messages
  - [ ] Add fallback mechanisms for unsupported markets
  - [ ] Enhance logging for market-specific operations
  - [ ] Implement rate limiting per market
  - [ ] Add market performance monitoring

- [ ] **Task 8: Testing Multi-Market Functionality** (AC: All)
  - [ ] Unit tests for each market's prompt generation
  - [ ] Integration tests for Portuguese translation
  - [ ] Performance tests across all four markets
  - [ ] Market-specific compliance validation tests
  - [ ] Database integration tests with market indexes
  - [ ] End-to-end tests for each market flow

## Dev Notes

### Previous Story Dependencies
**Story 1.2 (Core AI Engine)** implemented the foundational `/generate` endpoint for EU/Spain market.
This story extends that functionality to support three additional global markets with region-specific requirements.

### Market Requirements Research
[Source: docs/prd/product-requirements-document-smartlabel-ai.md#functional-requirements]

**Target Markets for Global Expansion:**
- **FR2**: Support for Spain (EU), Angola, Macau, and Brazil
- **FR3**: Portuguese translation for Brazilian and Angolan markets
- **FR4**: Market-specific certifications (IFS and local standards)

**Market-Specific Context:**
- **Angola**: Former Portuguese colony, Portuguese language, developing food safety standards
- **Macau**: Chinese SAR with Portuguese heritage, dual language requirements
- **Brazil**: Large Portuguese-speaking market, ANVISA regulations, organic certification focus

### Enhanced Data Models
[Source: Story 1.2 and architecture/data-models]

**Extended Market Support:**
```typescript
export type Market = 'EU' | 'ES' | 'AO' | 'MO' | 'BR';
export type Language = 'en' | 'pt' | 'pt-BR';

export interface MarketSpecificData {
  certifications: string[];
  localRegulations: string[];
  culturalConsiderations: string[];
  languageVariant?: string;
}

export interface Label {
  labelId: string;
  productId?: string;
  market: Market;
  language: Language;
  labelData: LabelData;
  marketSpecificData: MarketSpecificData;
  translatedData?: LabelData; // For Portuguese markets
  createdAt: string;
  generatedBy: string;
}
```

### Market-Specific Prompt Strategy
**Prompt Template System:**
- Base template with market-specific sections
- Cultural and regulatory context injection
- Language-specific formatting requirements
- Local certification integration

**Market Contexts:**
- **EU/Spain**: Existing implementation, EU regulations
- **Angola**: Portuguese language, developing standards, tropical climate considerations
- **Macau**: Dual cultural influence (Chinese/Portuguese), tourism food service focus
- **Brazil**: ANVISA regulations, large-scale agriculture, organic certification emphasis

### Translation Requirements
[Source: FR3 - Portuguese translation requirement]
- **Target Languages**: Portuguese for Angola and Brazil
- **Implementation**: Bilingual label generation (English + Portuguese)
- **Variations**: Brazilian Portuguese vs European Portuguese differences
- **Quality**: Translation validation and cultural appropriateness

### File Locations
[Source: architecture/source-tree.md]
- **Generate Handler**: `apps/api/src/handlers/generate.ts` (existing, to be extended)
- **Market Templates**: `apps/api/src/templates/markets/`
- **Translation Service**: `apps/api/src/services/translation.ts`
- **Market Types**: `packages/shared/types/markets.ts`
- **Market Schemas**: `packages/shared/schemas/markets.ts`

### Database Schema Extensions
[Source: architecture.md#database-schema]

**Enhanced LabelsTable:**
```yaml
LabelsTable:
  Type: AWS::DynamoDB::Table
  Properties:
    TableName: SmartLabel-Labels
    BillingMode: PAY_PER_REQUEST
    AttributeDefinitions:
      - { AttributeName: labelId, AttributeType: S }
      - { AttributeName: productId, AttributeType: S }
      - { AttributeName: market, AttributeType: S }
    KeySchema:
      - { AttributeName: labelId, KeyType: HASH }
    GlobalSecondaryIndexes:
      - IndexName: by-product
        KeySchema:
          - { AttributeName: productId, KeyType: HASH }
        Projection: { ProjectionType: ALL }
      - IndexName: by-market
        KeySchema:
          - { AttributeName: market, KeyType: HASH }
        Projection: { ProjectionType: ALL }
```

### Performance Requirements
[Source: NFR2 - 15-second response requirement]
- **All Markets**: Maintain sub-15-second response time
- **Translation Overhead**: Minimize impact of Portuguese translation
- **Prompt Complexity**: Optimize market-specific prompts for performance
- **Caching Strategy**: Consider market-specific caching patterns

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **GenAI Service**: AWS Bedrock (Claude) for all markets
- **Translation**: Integrated within Claude prompts vs external service
- **Validation**: Extended Zod schemas for market-specific data
- **Database**: Enhanced DynamoDB with market indexing

### Coding Standards
[Source: architecture/coding-standards.md]
- **Market Validation**: Strict typing with Market enum
- **Error Handling**: Market-specific error messages
- **Translation Quality**: Validation of Portuguese outputs
- **Performance Monitoring**: Track response times per market

### Security and Compliance
- **Data Residency**: Consider market-specific data requirements
- **Regulatory Compliance**: Ensure each market meets local food safety standards
- **Language Accuracy**: Validate translation quality for legal compliance

## Testing

### Testing Standards
[Source: architecture/tech-stack.md]
- **Unit Tests**: Jest for market-specific logic
- **Integration Tests**: End-to-end market flows
- **Performance Tests**: Response time validation per market
- **Compliance Tests**: Regulatory requirement validation

### Test Requirements for This Story
- **Market Logic Tests**:
  - Prompt generation for each market
  - Market-specific compliance validation
  - Translation accuracy and quality
  - Database market indexing
- **Integration Tests**:
  - Complete flow for each of the four markets
  - Portuguese translation workflow
  - Performance across all markets
- **Regression Tests**:
  - Ensure existing EU/Spain functionality unchanged
  - Backward compatibility for existing labels

### Test File Locations
- **Market Tests**: `apps/api/src/__tests__/markets/`
- **Translation Tests**: `apps/api/src/__tests__/translation/`
- **Integration Tests**: `apps/api/tests/integration/markets.test.ts`
- **Performance Tests**: `apps/api/tests/performance/markets.test.ts`

### Test Data Strategy
- **Market Scenarios**: Representative product data for each market
- **Translation Validation**: Known good Portuguese translations
- **Performance Baseline**: Establish per-market response time expectations
- **Compliance Validation**: Regulatory requirement test cases

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| Sep 17, 2025 | 1.0 | Initial story draft for Global Markets Backend Expansion | Bob, SM |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*TBD by dev agent*

### Debug Log References
*TBD by dev agent*

### Completion Notes List
*TBD by dev agent*

### File List
*TBD by dev agent*

## QA Results
*Results from QA Agent review will be added here after story completion*