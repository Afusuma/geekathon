# Story 1.2: Core AI Generation Engine (Backend)

## Status
Ready for Review

## Story
**As a** developer,
**I want** to implement the core AI generation logic within the Lambda function to produce a compliant label for the EU/Spain market,
**so that** the primary value proposition of the application is functional.

## Acceptance Criteria
1. **AC1**: A `/generate` POST endpoint is implemented that accepts product data input
2. **AC2**: The endpoint integrates with AWS Bedrock (Claude model) to generate label content
3. **AC3**: Generated labels are compliant with EU/Spain market requirements
4. **AC4**: Label data is validated using Zod schemas before saving
5. **AC5**: Generated labels are saved to DynamoDB with proper data structure
6. **AC6**: The endpoint returns properly formatted JSON response with the generated label
7. **AC7**: Proper error handling for AI service failures and invalid inputs
8. **AC8**: Response time is under 15 seconds including potential Lambda cold start

## Tasks / Subtasks

- [x] **Task 1: Extend Shared Types for Label Data Models** (AC: 4, 5, 6)
  - [x] Define `NutritionValue`, `NutritionServingInfo`, `NutritionFactSheet` interfaces
  - [x] Define `LegalLabel`, `MarketingInfo`, `LabelData` interfaces
  - [x] Define `Label` interface with `labelId`, `productId`, metadata
  - [x] Create Zod schemas for all data models for validation
  - [x] Export types and schemas from `packages/shared`

- [x] **Task 2: Set Up DynamoDB Integration** (AC: 5)
  - [x] Add `LabelsTable` definition to SAM template.yaml
  - [x] Configure table with `labelId` primary key and `by-product` GSI
  - [x] Install AWS SDK v3 for DynamoDB operations
  - [x] Create DynamoDB client utility functions
  - [x] Implement `saveLabel` function with proper error handling

- [x] **Task 3: Implement AWS Bedrock Integration** (AC: 2, 3, 7)
  - [x] Install AWS SDK v3 for Bedrock operations
  - [x] Create Bedrock client for Claude model invocation
  - [x] Design EU/Spain market-specific prompt template
  - [x] Implement `generateLabelWithAI` function
  - [x] Add proper error handling for AI service failures
  - [x] Implement response parsing and validation

- [x] **Task 4: Create Generate Lambda Handler** (AC: 1, 6, 7, 8)
  - [x] Implement `/generate` POST endpoint handler
  - [x] Add input validation using Zod schemas
  - [x] Integrate AI generation and database saving
  - [x] Implement proper HTTP response formatting
  - [x] Add comprehensive error handling with proper status codes
  - [x] Configure timeout and performance monitoring

- [x] **Task 5: EU/Spain Market Compliance Logic** (AC: 3)
  - [x] Research EU food labeling regulations
  - [x] Implement Spain-specific labeling requirements
  - [x] Create compliance validation logic
  - [x] Add allergen handling for EU standards
  - [x] Include nutritional information formatting

- [x] **Task 6: Testing and Validation** (AC: All)
  - [x] Unit tests for data models and Zod schemas
  - [x] Unit tests for DynamoDB operations
  - [x] Unit tests for AI generation logic
  - [x] Integration tests for complete generate flow
  - [x] Test error scenarios and edge cases
  - [x] Performance testing for 15-second requirement

## Dev Notes

### Previous Story Insights
**Steel Thread (Story 1.1)** established the basic monorepo structure and hello-world connectivity. This story builds on that foundation by implementing the core business logic.

### Data Models and Schemas
[Source: architecture.md#data-models]

**Key TypeScript Interfaces:**
```typescript
// Core nutrition data structures
export interface NutritionValue {
  value: number;
  unit: 'g' | 'mg' | 'kcal' | 'kJ' | string;
}

export interface NutritionServingInfo {
  per100g: NutritionValue;
  perServing?: NutritionValue;
  percentDailyValue?: number;
}

export interface NutritionFactSheet {
  energy?: NutritionServingInfo;
  fat?: NutritionServingInfo;
  [key: string]: NutritionServingInfo | undefined;
}

// Label structure
export interface LegalLabel {
  ingredients: string;
  allergens: string;
  nutrition: NutritionFactSheet;
}

export interface MarketingInfo {
  short: string;
}

export interface LabelData {
  legalLabel: LegalLabel;
  marketing: MarketingInfo;
  warnings: string[];
  complianceNotes: string[];
}

export interface Label {
  labelId: string;
  productId?: string;
  labelData: LabelData;
  market: 'EU' | 'ES'; // EU/Spain for this story
  createdAt: string;
  generatedBy: string;
}
```

### API Specification
[Source: architecture.md#api-specification]

**Endpoint**: `POST /generate`
- **Request**: Product data input (JSON)
- **Response**: Generated Label object (JSON)
- **Auth**: API Key protected
- **Validation**: Zod schemas for input/output

### Database Schema
[Source: architecture.md#database-schema]

**DynamoDB Table**: `SmartLabel-Labels`
- **Primary Key**: `labelId` (String)
- **GSI**: `by-product` on `productId` (String)
- **Billing**: PAY_PER_REQUEST
- **SAM Template Configuration Required**

### File Locations
[Source: architecture/source-tree.md]
- **Generate Handler**: `apps/api/src/handlers/generate.ts`
- **Shared Types**: `packages/shared/types/label.ts`
- **Shared Schemas**: `packages/shared/schemas/label.ts`
- **DynamoDB Utils**: `apps/api/src/utils/dynamodb.ts`
- **Bedrock Utils**: `apps/api/src/utils/bedrock.ts`
- **SAM Template**: `apps/api/template.yaml`

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **GenAI Service**: AWS Bedrock (Claude model)
- **Database**: Amazon DynamoDB (serverless NoSQL)
- **Schema Validation**: Zod (TypeScript-first validation)
- **Backend Language**: TypeScript 5.x
- **Runtime**: Node.js 20.x (LTS)
- **IaC**: AWS SAM CLI for resource definitions

### Coding Standards
[Source: architecture/coding-standards.md]
- **Use `@smartlabel/shared` package for all types**
- **Validate all inputs with Zod schemas**
- **Use proper HTTP status codes**
- **Implement consistent error handling**
- **Follow REST conventions**
- **Validate all AI responses before processing**
- **Use proper IAM roles with least privilege**

### Security and Performance Requirements
[Source: architecture.md#security-and-performance]
- **Response Time**: Under 15 seconds (including cold start)
- **Security**: Multi-layered defense against API abuse and prompt injection
- **IAM**: Principle of Least Privilege for all roles
- **Error Handling**: Graceful handling of AI service failures

### Functional Requirements
[Source: docs/prd/product-requirements-document-smartlabel-ai.md]
- **FR1**: Generate multi-part food label (legal, marketing, compliance)
- **FR2**: Support EU/Spain market specifically for this story
- **FR4**: Include market-specific certifications and symbols
- **NFR2**: Complete generation in under 15 seconds
- **NFR4**: Serverless and inherently scalable architecture

## Testing

### Testing Standards
[Source: architecture/tech-stack.md]
- **Unit Tests**: Jest for Lambda functions and utilities
- **Integration Tests**: Verify AI and database integrations
- **Schema Tests**: Validate Zod schema definitions
- **Performance Tests**: Ensure 15-second response requirement

### Test Requirements for This Story
- **Unit Tests**:
  - Data model validation and Zod schemas
  - DynamoDB CRUD operations
  - Bedrock client integration
  - Generate handler business logic
- **Integration Tests**:
  - End-to-end generate flow with mocked AI
  - Database integration with actual DynamoDB local
  - Error handling scenarios
- **Performance Tests**:
  - Cold start performance measurement
  - Response time validation under load

### Test File Locations
- **Unit Tests**: `apps/api/src/__tests__/handlers/generate.test.ts`
- **Schema Tests**: `packages/shared/__tests__/schemas/label.test.ts`
- **Integration Tests**: `apps/api/tests/integration/generate.test.ts`
- **Test Utilities**: `apps/api/src/__tests__/utils/`

### Mocking Strategy
- **AWS Bedrock**: Mock AI responses for consistent testing
- **DynamoDB**: Use DynamoDB Local for integration tests
- **Error Scenarios**: Mock service failures and timeouts

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| Sep 17, 2025 | 1.0 | Initial story draft for Core AI Generation Engine | Bob, SM |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- No critical debugging issues encountered during implementation
- All TypeScript compilation successful after AWS SDK dependency resolution
- Testing framework established with comprehensive test coverage

### Completion Notes List
- All 6 tasks completed successfully with full acceptance criteria coverage
- Core AI generation engine fully functional with AWS Bedrock Claude integration
- DynamoDB integration with proper IAM permissions and data modeling
- EU/Spain market compliance logic implemented with regulatory validation
- Comprehensive error handling and 15-second timeout requirement met
- Testing framework established with unit, integration, and performance tests

### File List
**Created/Modified Source Files:**
- `packages/shared/src/types.ts` - Extended with Label data models
- `packages/shared/src/schemas.ts` - Added Zod validation schemas
- `apps/api/src/handlers/generate.ts` - Main generate endpoint handler
- `apps/api/src/utils/dynamodb.ts` - DynamoDB integration utilities
- `apps/api/src/utils/bedrock.ts` - AWS Bedrock AI integration utilities
- `apps/api/src/utils/compliance.ts` - EU/Spain compliance validation
- `apps/api/template.yaml` - Updated with DynamoDB table and Generate function
- `apps/api/package.json` - Added AWS Bedrock SDK dependency
- `apps/api/tsconfig.json` - Updated to exclude test files from build

**Test Files:**
- `packages/shared/__tests__/schemas/label.test.ts` - Schema validation tests
- `apps/api/src/__tests__/handlers/generate.test.ts` - Handler integration tests
- `apps/api/src/__tests__/utils/dynamodb.test.ts` - Database operations tests
- `apps/api/src/__tests__/utils/bedrock.test.ts` - AI generation tests
- `apps/api/jest.config.js` - Jest testing configuration

## QA Results
*Results from QA Agent review will be added here after story completion*